#!/usr/bin/env bash

<% require_relative 'helpers' %>

die ()
{
    echo "[die]: $1"
    exit 1
}

runningOSX ()
{
    uname -a | grep "Darwin" > /dev/null
}

runningLinux ()
{
    uname -a | grep -i "Linux" > /dev/null
}

running32Bit ()
{
    [ "$(lshw -c cpu 2>/dev/null | grep width | awk '{print $2}')" = "32" ]
}

running64Bit ()
{
    [ "$(lshw -c cpu 2>/dev/null | grep width | awk '{print $2}')" = "64" ]
}

runningAmd64 ()
{
    [ "$(uname -m)" = 'x86_64' ]
}

running386 ()
{
    local arch="$(uname -m)"
    [ "$arch" = 'i686' ] || [ "$arch" = 'i386' ]
}

#runningArm ()
#{
#}
#
#runningArm64 ()
#{
#}

mac_link ()
{
    echo '<%= Helpers.url(Helpers.latest_release_name, 'darwin', 'amd64') %>'
}

linux_link ()
{
    echo '<%= Helpers.url(Helpers.latest_release_name, 'linux', 'amd64') %>'
}

downlink_link ()
{
    curl -o "${1}/<%= Helpers.zip_name %>" "${2}"
}

main ()
{
    dest_dir="${HOME}/bin"
    [ -n "$1" ] && dest_dir="$1"
    mkdir -p "${dest_dir}"

    bin_name=''

    if runningLinux; then
        bin_name='<%= Helpers.bin_name('linux') %>'
        downlink_link "${dest_dir}" "$(linux_link)"
    elif runningOSX; then
        bin_name='<%= Helpers.bin_name('darwin') %>'
        downlink_link "${dest_dir}" "$(mac_link)"
    else
        die 'Unsupported platform!'
    fi

    cd "${dest_dir}"

    # If there's already a findref version, remove it
    rm -f "${bin_name}"
    unzip '<%= Helpers.zip_name %>'
    rm -f '<%= Helpers.zip_name %>'
    chmod +x "${bin_name}"
}

main $@
